generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================
// Multi-Tenancy
// ============================================================

model Tenant {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  plan        String   @default("starter") // starter | professional | enterprise
  ssoEnabled  Boolean  @default(false)
  ssoConfig   String?  // JSON: SAML/OIDC configuration
  ldapEnabled Boolean  @default(false)
  ldapConfig  String?  // JSON: LDAP connection settings
  settings    String   @default("{}") // JSON: tenant-level settings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  invitations Invitation[]
  projects    Project[]
  auditLogs   AuditLog[]
  apiKeys     ApiKey[]
  approvalPipelines ApprovalPipeline[]
  complianceFrameworks ComplianceFramework[]
}

// ============================================================
// Authentication & Authorization
// ============================================================

model User {
  id         String    @id @default(uuid())
  email      String    @unique
  name       String
  password   String    // bcrypt hashed
  role       String    @default("editor") // admin | editor | viewer
  tenantId   String
  avatar     String?
  lastLogin  DateTime?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessions          Session[]
  auditLogs         AuditLog[]
  notifications     Notification[]
  approvalRequests  ApprovalRequest[]   @relation("requestedBy")
  approvalReviews   ApprovalRequest[]   @relation("reviewedBy")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Invitation {
  id        String   @id @default(uuid())
  email     String
  role      String   @default("editor")
  tenantId  String
  token     String   @unique
  expiresAt DateTime
  accepted  Boolean  @default(false)
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// ============================================================
// Core Business Rules (updated with tenant scoping)
// ============================================================

model Project {
  id          String   @id @default(uuid())
  tenantId    String?
  name        String
  description String   @default("")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant     Tenant?     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ruleSets   RuleSet[]
  dataModels DataModel[]
  workflows  Workflow[]
  adapters   Adapter[]
}

model DataModel {
  id        String   @id @default(uuid())
  projectId String
  name      String
  schema    String   // JSON string of the schema definition
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  ruleSets RuleSet[]
}

model RuleSet {
  id           String   @id @default(uuid())
  projectId    String
  name         String
  description  String   @default("")
  inputModelId String?
  status       String   @default("draft") // draft | review | approved | published | archived
  version      Int      @default(1)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project          Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  inputModel       DataModel?         @relation(fields: [inputModelId], references: [id])
  rules            Rule[]
  decisionTables   DecisionTable[]
  versions         RuleSetVersion[]
  executionLogs    ExecutionLog[]
  simulationRuns   SimulationRun[]
  approvalRequests ApprovalRequest[]
  scheduledJobs    ScheduledJob[]
}

model Rule {
  id          String   @id @default(uuid())
  ruleSetId   String
  name        String
  description String   @default("")
  priority    Int      @default(0)
  conditions  String   // JSON string of condition tree
  actions     String   // JSON string of action list
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ruleSet RuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
}

model DecisionTable {
  id          String   @id @default(uuid())
  ruleSetId   String
  name        String
  description String   @default("")
  columns     String   // JSON: column definitions
  rows        String   // JSON: row data
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ruleSet RuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
}

model RuleSetVersion {
  id          String   @id @default(uuid())
  ruleSetId   String
  version     Int
  snapshot    String   // JSON: complete snapshot of rules + tables
  changelog   String   @default("")
  publishedAt DateTime @default(now())
  publishedBy String   @default("system")

  ruleSet RuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
}

model ExecutionLog {
  id              String   @id @default(uuid())
  ruleSetId       String
  version         Int
  input           String   // JSON
  output          String   // JSON
  rulesFired      String   // JSON: array of rule IDs that fired
  executionTimeMs Int
  status          String   // success | error
  error           String?
  createdAt       DateTime @default(now())

  ruleSet RuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
}

model QueueJob {
  id          String    @id @default(uuid())
  queue       String    @default("rule-execution")
  payload     String    // JSON
  status      String    @default("pending") // pending | processing | completed | failed
  result      String?   // JSON
  error       String?
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
}

// ============================================================
// BPMN Workflow Engine
// ============================================================

model Workflow {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  description String   @default("")
  nodes       String   @default("[]") // JSON: React Flow nodes
  edges       String   @default("[]") // JSON: React Flow edges
  variables   String   @default("{}") // JSON: workflow-level variable definitions
  status      String   @default("draft") // draft | active | archived
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project   Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  instances WorkflowInstance[]
  scheduledJobs ScheduledJob[]
}

model WorkflowInstance {
  id          String    @id @default(uuid())
  workflowId  String
  input       String    @default("{}") // JSON: input data
  state       String    @default("{}") // JSON: current execution state + variables
  currentNode String?   // ID of the current node being executed
  status      String    @default("running") // running | completed | failed | paused | cancelled
  output      String?   // JSON: final output
  error       String?
  logs        String    @default("[]") // JSON: execution trace
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
}

// ============================================================
// Integration Adapters
// ============================================================

model Adapter {
  id           String    @id @default(uuid())
  projectId    String
  name         String
  type         String    // rest | database | webhook | file
  config       String    @default("{}") // JSON: connection configuration
  authConfig   String    @default("{}") // JSON: auth settings (API keys, credentials)
  headers      String    @default("{}") // JSON: default headers (for REST)
  status       String    @default("inactive") // active | inactive | error
  lastTestedAt DateTime?
  lastError    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

// ============================================================
// Audit Logging
// ============================================================

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String?
  userId     String?
  userName   String?
  action     String   // create | update | delete | execute | publish | rollback | login | logout | invite
  entity     String   // project | ruleSet | rule | decisionTable | dataModel | workflow | adapter | user | tenant
  entityId   String?
  entityName String?
  before     String?  // JSON: state before change
  after      String?  // JSON: state after change
  metadata   String?  // JSON: additional context (IP, user-agent, etc.)
  createdAt  DateTime @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id])
  user   User?   @relation(fields: [userId], references: [id])
}

// ============================================================
// V3: Notifications
// ============================================================

model Notification {
  id         String   @id @default(uuid())
  userId     String
  tenantId   String?
  type       String   // info | success | warning | error | approval | publish | execution
  title      String
  message    String
  entityType String?  // ruleSet | workflow | project | etc.
  entityId   String?
  link       String?  // deep link path within the app
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================================
// V3: What-If Simulation
// ============================================================

model SimulationRun {
  id          String    @id @default(uuid())
  ruleSetId   String
  name        String
  description String    @default("")
  datasetType String    @default("inline") // inline | csv
  dataset     String    // JSON: array of test cases [{input, expectedOutput?}]
  results     String?   // JSON: array of results with pass/fail per case
  stats       String?   // JSON: {total, passed, failed, avgExecutionMs, coverage}
  status      String    @default("pending") // pending | running | completed | failed
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  ruleSet RuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
}

// ============================================================
// V4: Approval Workflows
// ============================================================

model ApprovalPipeline {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  stages    String   // JSON: [{name, requiredRole, autoApprove?}]
  entityType String  @default("ruleSet") // ruleSet | workflow
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  requests ApprovalRequest[]
}

model ApprovalRequest {
  id           String    @id @default(uuid())
  pipelineId   String
  ruleSetId    String?
  entityType   String    // ruleSet | workflow
  entityId     String
  entityName   String    @default("")
  currentStage Int       @default(0)
  status       String    @default("pending") // pending | approved | rejected | cancelled
  requestedById String
  reviewedById  String?
  comments     String    @default("[]") // JSON: [{userId, userName, text, timestamp}]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  pipeline    ApprovalPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  ruleSet     RuleSet?         @relation(fields: [ruleSetId], references: [id])
  requestedBy User             @relation("requestedBy", fields: [requestedById], references: [id])
  reviewedBy  User?            @relation("reviewedBy", fields: [reviewedById], references: [id])
}

// ============================================================
// V4: API Gateway
// ============================================================

model ApiKey {
  id          String    @id @default(uuid())
  tenantId    String
  name        String
  key         String    @unique
  permissions String    @default("[]") // JSON: ["execute", "read", "write"]
  rateLimit   Int       @default(1000) // requests per hour
  usageCount  Int       @default(0)
  lastUsedAt  DateTime?
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// ============================================================
// V4: Scheduled Executions
// ============================================================

model ScheduledJob {
  id             String    @id @default(uuid())
  tenantId       String?
  name           String
  entityType     String    // ruleSet | workflow
  entityId       String
  ruleSetId      String?
  workflowId     String?
  cronExpression String
  input          String    @default("{}") // JSON: default input
  timezone       String    @default("UTC")
  enabled        Boolean   @default(true)
  lastRunAt      DateTime?
  nextRunAt      DateTime?
  lastStatus     String?   // success | error
  lastError      String?
  runCount       Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  ruleSet  RuleSet?  @relation(fields: [ruleSetId], references: [id])
  workflow Workflow? @relation(fields: [workflowId], references: [id])
}

// ============================================================
// V4: Template Marketplace
// ============================================================

model Template {
  id          String   @id @default(uuid())
  name        String
  description String   @default("")
  category    String   // insurance | healthcare | finance | compliance | general
  tags        String   @default("[]") // JSON: array of tag strings
  content     String   // JSON: full exportable project/ruleSet content
  type        String   @default("ruleSet") // ruleSet | workflow | project
  author      String   @default("SOA One Team")
  downloads   Int      @default(0)
  rating      Float    @default(0)
  ratingCount Int      @default(0)
  isOfficial  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================================
// V4: Compliance & Regulatory
// ============================================================

model ComplianceFramework {
  id           String    @id @default(uuid())
  tenantId     String
  name         String    // e.g., "SOX Compliance", "HIPAA Privacy Rule"
  framework    String    // sox | hipaa | gdpr | pci | custom
  description  String    @default("")
  requirements String    @default("[]") // JSON: [{id, name, description, category, status, linkedRuleSetIds}]
  status       String    @default("active") // active | archived
  certifiedAt  DateTime?
  certifiedBy  String?
  retentionDays Int      @default(2555) // ~7 years default for SOX
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}
