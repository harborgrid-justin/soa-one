generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ============================================================
// Multi-Tenancy
// ============================================================

model Tenant {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  plan        String   @default("starter") // starter | professional | enterprise
  ssoEnabled  Boolean  @default(false)
  ssoConfig   String?  // JSON: SAML/OIDC configuration
  ldapEnabled Boolean  @default(false)
  ldapConfig  String?  // JSON: LDAP connection settings
  settings    String   @default("{}") // JSON: tenant-level settings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  invitations Invitation[]
  projects    Project[]
  auditLogs   AuditLog[]
  apiKeys     ApiKey[]
  approvalPipelines ApprovalPipeline[]
  complianceFrameworks ComplianceFramework[]
}

// ============================================================
// Authentication & Authorization
// ============================================================

model User {
  id         String    @id @default(uuid())
  email      String    @unique
  name       String
  password   String    // bcrypt hashed
  role       String    @default("editor") // admin | editor | viewer
  tenantId   String
  avatar     String?
  lastLogin  DateTime?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessions          Session[]
  auditLogs         AuditLog[]
  notifications     Notification[]
  approvalRequests  ApprovalRequest[]   @relation("requestedBy")
  approvalReviews   ApprovalRequest[]   @relation("reviewedBy")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Invitation {
  id        String   @id @default(uuid())
  email     String
  role      String   @default("editor")
  tenantId  String
  token     String   @unique
  expiresAt DateTime
  accepted  Boolean  @default(false)
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// ============================================================
// Core Business Rules (updated with tenant scoping)
// ============================================================

model Project {
  id          String   @id @default(uuid())
  tenantId    String?
  name        String
  description String   @default("")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant     Tenant?     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ruleSets   RuleSet[]
  dataModels DataModel[]
  workflows  Workflow[]
  adapters   Adapter[]
}

model DataModel {
  id        String   @id @default(uuid())
  projectId String
  name      String
  schema    String   // JSON string of the schema definition
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  ruleSets RuleSet[]
}

model RuleSet {
  id           String   @id @default(uuid())
  projectId    String
  name         String
  description  String   @default("")
  inputModelId String?
  status       String   @default("draft") // draft | review | approved | published | archived
  version      Int      @default(1)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project          Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  inputModel       DataModel?         @relation(fields: [inputModelId], references: [id])
  rules            Rule[]
  decisionTables   DecisionTable[]
  versions         RuleSetVersion[]
  executionLogs    ExecutionLog[]
  simulationRuns   SimulationRun[]
  approvalRequests ApprovalRequest[]
  scheduledJobs    ScheduledJob[]
}

model Rule {
  id          String   @id @default(uuid())
  ruleSetId   String
  name        String
  description String   @default("")
  priority    Int      @default(0)
  conditions  String   // JSON string of condition tree
  actions     String   // JSON string of action list
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ruleSet RuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
}

model DecisionTable {
  id          String   @id @default(uuid())
  ruleSetId   String
  name        String
  description String   @default("")
  columns     String   // JSON: column definitions
  rows        String   // JSON: row data
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ruleSet RuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
}

model RuleSetVersion {
  id          String   @id @default(uuid())
  ruleSetId   String
  version     Int
  snapshot    String   // JSON: complete snapshot of rules + tables
  changelog   String   @default("")
  publishedAt DateTime @default(now())
  publishedBy String   @default("system")

  ruleSet RuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
}

model ExecutionLog {
  id              String   @id @default(uuid())
  ruleSetId       String
  version         Int
  input           String   // JSON
  output          String   // JSON
  rulesFired      String   // JSON: array of rule IDs that fired
  executionTimeMs Int
  status          String   // success | error
  error           String?
  createdAt       DateTime @default(now())

  ruleSet RuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
}

model QueueJob {
  id          String    @id @default(uuid())
  queue       String    @default("rule-execution")
  payload     String    // JSON
  status      String    @default("pending") // pending | processing | completed | failed
  result      String?   // JSON
  error       String?
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
}

// ============================================================
// BPMN Workflow Engine
// ============================================================

model Workflow {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  description String   @default("")
  nodes       String   @default("[]") // JSON: React Flow nodes
  edges       String   @default("[]") // JSON: React Flow edges
  variables   String   @default("{}") // JSON: workflow-level variable definitions
  status      String   @default("draft") // draft | active | archived
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project   Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  instances WorkflowInstance[]
  scheduledJobs ScheduledJob[]
}

model WorkflowInstance {
  id          String    @id @default(uuid())
  workflowId  String
  input       String    @default("{}") // JSON: input data
  state       String    @default("{}") // JSON: current execution state + variables
  currentNode String?   // ID of the current node being executed
  status      String    @default("running") // running | completed | failed | paused | cancelled
  output      String?   // JSON: final output
  error       String?
  logs        String    @default("[]") // JSON: execution trace
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
}

// ============================================================
// Integration Adapters
// ============================================================

model Adapter {
  id           String    @id @default(uuid())
  projectId    String
  name         String
  type         String    // rest | database | webhook | file
  config       String    @default("{}") // JSON: connection configuration
  authConfig   String    @default("{}") // JSON: auth settings (API keys, credentials)
  headers      String    @default("{}") // JSON: default headers (for REST)
  status       String    @default("inactive") // active | inactive | error
  lastTestedAt DateTime?
  lastError    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

// ============================================================
// Audit Logging
// ============================================================

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String?
  userId     String?
  userName   String?
  action     String   // create | update | delete | execute | publish | rollback | login | logout | invite
  entity     String   // project | ruleSet | rule | decisionTable | dataModel | workflow | adapter | user | tenant
  entityId   String?
  entityName String?
  before     String?  // JSON: state before change
  after      String?  // JSON: state after change
  metadata   String?  // JSON: additional context (IP, user-agent, etc.)
  createdAt  DateTime @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id])
  user   User?   @relation(fields: [userId], references: [id])
}

// ============================================================
// V3: Notifications
// ============================================================

model Notification {
  id         String   @id @default(uuid())
  userId     String
  tenantId   String?
  type       String   // info | success | warning | error | approval | publish | execution
  title      String
  message    String
  entityType String?  // ruleSet | workflow | project | etc.
  entityId   String?
  link       String?  // deep link path within the app
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================================
// V3: What-If Simulation
// ============================================================

model SimulationRun {
  id          String    @id @default(uuid())
  ruleSetId   String
  name        String
  description String    @default("")
  datasetType String    @default("inline") // inline | csv
  dataset     String    // JSON: array of test cases [{input, expectedOutput?}]
  results     String?   // JSON: array of results with pass/fail per case
  stats       String?   // JSON: {total, passed, failed, avgExecutionMs, coverage}
  status      String    @default("pending") // pending | running | completed | failed
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  ruleSet RuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
}

// ============================================================
// V4: Approval Workflows
// ============================================================

model ApprovalPipeline {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  stages    String   // JSON: [{name, requiredRole, autoApprove?}]
  entityType String  @default("ruleSet") // ruleSet | workflow
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  requests ApprovalRequest[]
}

model ApprovalRequest {
  id           String    @id @default(uuid())
  pipelineId   String
  ruleSetId    String?
  entityType   String    // ruleSet | workflow
  entityId     String
  entityName   String    @default("")
  currentStage Int       @default(0)
  status       String    @default("pending") // pending | approved | rejected | cancelled
  requestedById String
  reviewedById  String?
  comments     String    @default("[]") // JSON: [{userId, userName, text, timestamp}]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  pipeline    ApprovalPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  ruleSet     RuleSet?         @relation(fields: [ruleSetId], references: [id])
  requestedBy User             @relation("requestedBy", fields: [requestedById], references: [id])
  reviewedBy  User?            @relation("reviewedBy", fields: [reviewedById], references: [id])
}

// ============================================================
// V4: API Gateway
// ============================================================

model ApiKey {
  id          String    @id @default(uuid())
  tenantId    String
  name        String
  key         String    @unique
  permissions String    @default("[]") // JSON: ["execute", "read", "write"]
  rateLimit   Int       @default(1000) // requests per hour
  usageCount  Int       @default(0)
  lastUsedAt  DateTime?
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// ============================================================
// V4: Scheduled Executions
// ============================================================

model ScheduledJob {
  id             String    @id @default(uuid())
  tenantId       String?
  name           String
  entityType     String    // ruleSet | workflow
  entityId       String
  ruleSetId      String?
  workflowId     String?
  cronExpression String
  input          String    @default("{}") // JSON: default input
  timezone       String    @default("UTC")
  enabled        Boolean   @default(true)
  lastRunAt      DateTime?
  nextRunAt      DateTime?
  lastStatus     String?   // success | error
  lastError      String?
  runCount       Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  ruleSet  RuleSet?  @relation(fields: [ruleSetId], references: [id])
  workflow Workflow? @relation(fields: [workflowId], references: [id])
}

// ============================================================
// V4: Template Marketplace
// ============================================================

model Template {
  id          String   @id @default(uuid())
  name        String
  description String   @default("")
  category    String   // insurance | healthcare | finance | compliance | general
  tags        String   @default("[]") // JSON: array of tag strings
  content     String   // JSON: full exportable project/ruleSet content
  type        String   @default("ruleSet") // ruleSet | workflow | project
  author      String   @default("SOA One Team")
  downloads   Int      @default(0)
  rating      Float    @default(0)
  ratingCount Int      @default(0)
  isOfficial  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================================
// V4: Compliance & Regulatory
// ============================================================

model ComplianceFramework {
  id           String    @id @default(uuid())
  tenantId     String
  name         String    // e.g., "SOX Compliance", "HIPAA Privacy Rule"
  framework    String    // sox | hipaa | gdpr | pci | custom
  description  String    @default("")
  requirements String    @default("[]") // JSON: [{id, name, description, category, status, linkedRuleSetIds}]
  status       String    @default("active") // active | archived
  certifiedAt  DateTime?
  certifiedBy  String?
  retentionDays Int      @default(2555) // ~7 years default for SOX
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// ============================================================
// V7: Multi-Environment Promotion
// ============================================================

model Environment {
  id        String   @id @default(uuid())
  tenantId  String
  name      String   // development | staging | production | custom
  slug      String
  color     String   @default("#6366f1") // visual indicator
  order     Int      @default(0) // promotion order
  isDefault Boolean  @default(false)
  locked    Boolean  @default(false) // production environments can be locked
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  promotions      Promotion[]
  promotionTargets Promotion[] @relation("targetEnv")
}

model Promotion {
  id             String   @id @default(uuid())
  tenantId       String
  ruleSetId      String
  sourceEnvId    String
  targetEnvId    String
  ruleSetVersion Int
  snapshot       String   // JSON: full rule set snapshot at promotion time
  status         String   @default("pending") // pending | approved | promoted | rejected
  promotedBy     String?
  approvedBy     String?
  notes          String   @default("")
  createdAt      DateTime @default(now())
  promotedAt     DateTime?

  sourceEnv Environment  @relation(fields: [sourceEnvId], references: [id])
  targetEnv Environment  @relation("targetEnv", fields: [targetEnvId], references: [id])
}

// ============================================================
// V7: Custom Function Library
// ============================================================

model CustomFunction {
  id          String   @id @default(uuid())
  tenantId    String
  name        String   // e.g., calculateAge, checkBlacklist
  description String   @default("")
  code        String   // JavaScript function body
  parameters  String   @default("[]") // JSON: [{name, type, description}]
  returnType  String   @default("any") // string | number | boolean | object | any
  version     Int      @default(1)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================================
// V7: RBAC Permissions
// ============================================================

model Permission {
  id        String   @id @default(uuid())
  tenantId  String
  role      String   // admin | editor | viewer | approver | custom
  resource  String   // project | ruleSet | rule | workflow | adapter | execution | approval | user
  actions   String   // JSON: ["create", "read", "update", "delete", "publish", "execute", "approve"]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================
// V7: Decision Trace
// ============================================================

model DecisionTrace {
  id              String   @id @default(uuid())
  executionLogId  String
  ruleSetId       String
  input           String   // JSON: original input
  trace           String   // JSON: [{ruleId, ruleName, evaluated: true/false, conditionResults: [{field, operator, value, actualValue, matched}], actionsTaken: [...]}]
  summary         String   // JSON: {totalRulesEvaluated, rulesFired, rulesSkipped, executionOrder: []}
  createdAt       DateTime @default(now())
}

// ============================================================
// V7: Compliance Reports
// ============================================================

model ComplianceReport {
  id           String   @id @default(uuid())
  tenantId     String
  frameworkId  String?
  name         String
  type         String   // audit-trail | change-summary | decision-report | compliance-status
  parameters   String   @default("{}") // JSON: date range, entity filters, etc.
  content      String   // JSON: generated report data
  format       String   @default("json") // json | csv
  generatedBy  String
  createdAt    DateTime @default(now())
}

// ============================================================
// V8: A/B Testing for Rules
// ============================================================

model ABTest {
  id          String    @id @default(uuid())
  tenantId    String
  ruleSetId   String
  name        String
  description String    @default("")
  variantA    String    // version number or snapshot ID for control
  variantB    String    // version number or snapshot ID for experiment
  splitRatio  Int       @default(50) // % of traffic to variant B
  status      String    @default("draft") // draft | running | paused | completed
  startedAt   DateTime?
  completedAt DateTime?
  metrics     String    @default("{}") // JSON: {variantA: {executions, successes, avgTime}, variantB: {...}}
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ============================================================
// V8: Rule Impact Analysis
// ============================================================

model ImpactAnalysis {
  id          String   @id @default(uuid())
  ruleSetId   String
  ruleId      String?
  changeType  String   // add | modify | delete | enable | disable
  changeSummary String @default("") // human-readable description
  affectedRules String @default("[]") // JSON: [{ruleId, ruleName, impact: 'direct' | 'indirect'}]
  affectedWorkflows String @default("[]") // JSON: [{workflowId, workflowName}]
  riskLevel   String   @default("low") // low | medium | high | critical
  sampleResults String @default("{}") // JSON: {before: {approvalRate, avgTime}, after: {approvalRate, avgTime}}
  createdAt   DateTime @default(now())
}

// ============================================================
// V8: Execution Replay
// ============================================================

model ExecutionReplay {
  id              String   @id @default(uuid())
  originalLogId   String   // reference to original ExecutionLog
  ruleSetId       String
  ruleSetVersion  Int      // version used for replay
  originalVersion Int      // version from original execution
  input           String   // JSON: same input as original
  originalOutput  String   // JSON: output from original execution
  replayOutput    String   // JSON: output from replay with new rules
  diff            String   @default("{}") // JSON: {changed: true, fieldChanges: [{field, before, after}]}
  createdAt       DateTime @default(now())
}

// ============================================================
// V9: Enterprise Service Bus (ESB)
// ============================================================

model ESBChannel {
  id           String   @id @default(uuid())
  tenantId     String?
  name         String
  type         String   @default("point-to-point") // point-to-point | pub-sub | dead-letter | request-reply | priority
  config       String   @default("{}") // JSON: ChannelConfig (maxDepth, ttl, deduplication, etc.)
  status       String   @default("active") // active | paused | draining | closed
  messageCount Int      @default(0)
  errorCount   Int      @default(0)
  lastActivity DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ESBEndpoint {
  id         String   @id @default(uuid())
  tenantId   String?
  name       String
  channelId  String?
  protocol   String   @default("rest") // rest | soap | jms
  config     String   @default("{}") // JSON: EndpointConfig (url, method, headers, auth, etc.)
  status     String   @default("active") // active | inactive | error
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model ESBRoute {
  id         String   @id @default(uuid())
  tenantId   String?
  name       String
  source     String   // source channel name
  strategy   String   @default("content-based") // content-based | header-based | round-robin | weighted | failover | multicast | priority-based | dynamic | itinerary | recipient-list
  conditions String   @default("[]") // JSON: routing conditions
  targets    String   @default("[]") // JSON: destination channel names
  priority   Int      @default(0)
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model ESBTransformer {
  id         String   @id @default(uuid())
  tenantId   String?
  name       String
  channel    String?  // bound to a specific channel, or null for reusable
  pipeline   String   @default("[]") // JSON: array of TransformerConfig steps
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model ESBSagaDefinition {
  id            String   @id @default(uuid())
  tenantId      String?
  name          String
  description   String   @default("")
  steps         String   @default("[]") // JSON: SagaStep definitions
  timeout       Int?     // overall saga timeout in ms
  retryPolicy   String?  // JSON: RetryPolicy
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  instances ESBSagaInstance[]
}

model ESBSagaInstance {
  id           String    @id @default(uuid())
  definitionId String
  status       String    @default("running") // running | completed | compensating | compensated | failed
  context      String    @default("{}") // JSON: saga context/state
  currentStep  Int       @default(0)
  logs         String    @default("[]") // JSON: step execution logs
  error        String?
  startedAt    DateTime  @default(now())
  completedAt  DateTime?

  definition ESBSagaDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)
}

model ESBMessage {
  id            String   @id @default(uuid())
  tenantId      String?
  channelName   String
  type          String   @default("event") // command | event | document | query | reply
  headers       String   @default("{}") // JSON: message headers
  body          String   @default("{}") // JSON: message payload
  status        String   @default("pending") // pending | delivered | failed | dead-letter
  correlationId String?
  causationId   String?
  error         String?
  createdAt     DateTime @default(now())
  deliveredAt   DateTime?
}

model ESBMetricSnapshot {
  id              String   @id @default(uuid())
  tenantId        String?
  totalMessages   Int      @default(0)
  deliveredCount  Int      @default(0)
  failedCount     Int      @default(0)
  avgLatencyMs    Float    @default(0)
  activeChannels  Int      @default(0)
  activeEndpoints Int      @default(0)
  activeSagas     Int      @default(0)
  circuitBreakers String   @default("{}") // JSON: circuit breaker states
  rateLimiters    String   @default("{}") // JSON: rate limiter states
  snapshot        String   @default("{}") // JSON: full ESBMetrics snapshot
  createdAt       DateTime @default(now())
}
